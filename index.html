<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Crochet 2 en 1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #FDFBF8;
            color: #4A4A4A;
        }
        .card {
            background-color: #FFFFFF;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            padding: 1.5rem;
            transition: all 0.3s ease-in-out;
        }
        .btn {
            display: inline-block;
            padding: 0.6rem 1.2rem;
            border-radius: 0.5rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }
        .btn-primary {
            background-color: #D57A66;
            color: #FFFFFF;
        }
        .btn-primary:hover {
            background-color: #C06C59;
        }
        .btn-secondary {
            background-color: #F0EBE3;
            color: #796E63;
        }
        .btn-secondary:hover {
            background-color: #E1D9CF;
        }
        .input-field {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid #D1D5DB;
            border-radius: 0.5rem;
            transition: border-color 0.2s;
        }
        .input-field:focus {
            outline: none;
            border-color: #D57A66;
            box-shadow: 0 0 0 2px rgba(213, 122, 102, 0.2);
        }
        .price-display {
            background-color: #E8CFC8;
            color: #754436;
            padding: 1.5rem;
            border-radius: 0.75rem;
            text-align: center;
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 350px;
            margin-left: auto;
            margin-right: auto;
            height: auto;
            min-height: 250px;
        }
    </style>
</head>
<body>

    <main class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="text-center mb-10">
            <h1 class="text-4xl font-bold text-[#754436]">Calculadora de Precios de Crochet 游빘</h1>
            <p class="mt-2 text-lg text-gray-600">Calcula el precio de venta de tus proyectos de zapatitos y amigurumis.</p>
        </header>

        <!-- Secci칩n de ejemplo de uso -->
        <section class="card mb-8">
            <h2 class="text-2xl font-semibold mb-1 text-[#754436]">Gu칤a R치pida con Ejemplo</h2>
            <p class="text-gray-600 mb-4">Sigue estos pasos sencillos para calcular el precio de un par de zapatitos.</p>
            <ol class="list-none space-y-4 text-gray-700">
                <li class="flex items-start gap-3">
                    <span class="text-2xl">游닍</span>
                    <div>
                        <p class="font-bold">Paso 1: Define tus Materiales Globales.</p>
                        <p>En el inventario de abajo, ingresa los datos de tus materiales. Por ejemplo, si un ovillo de 100g de hilo de algod칩n te cost칩 S/ 15, la calculadora sabr치 que 1g cuesta S/ 0.15.</p>
                    </div>
                </li>
                <li class="flex items-start gap-3">
                    <span class="text-2xl">游닇</span>
                    <div>
                        <p class="font-bold">Paso 2: Rellena los detalles del Producto.</p>
                        <p>En el apartado de Zapatitos, elige el material de tu inventario e indica la cantidad exacta que usaste (ej. 50g de hilo). Luego, agrega las horas de trabajo (ej. 3 horas).</p>
                    </div>
                </li>
                <li class="flex items-start gap-3">
                    <span class="text-2xl">游눯</span>
                    <div>
                        <p class="font-bold">Paso 3: Ajusta tu Ganancia.</p>
                        <p>Usa el deslizador para elegir un porcentaje de ganancia o introduce directamente un precio de venta de S/ 45. Ver치s c칩mo la calculadora muestra el desglose del costo y la ganancia neta.</p>
                    </div>
                </li>
                <li class="flex items-start gap-3">
                    <span class="text-2xl">游늵</span>
                    <div>
                        <p class="font-bold">춰Listo!</p>
                        <p>El costo de producci칩n, el desglose detallado, el precio de venta sugerido y tu ganancia neta se calcular치n autom치ticamente.</p>
                    </div>
                </li>
            </ol>
        </section>
        
        <!-- Lista de precios de referencia -->
        <section class="card mb-8">
            <h2 class="text-2xl font-semibold mb-2 text-[#754436]">Precios de Referencia (Sugeridos)</h2>
            <p class="text-gray-600 mb-4">Estos precios son un rango aproximado basado en el mercado online y pueden variar seg칰n la complejidad, el tama침o y tu regi칩n. 춰칔salos como una gu칤a!</p>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="bg-gray-100 p-4 rounded-lg">
                    <h3 class="font-bold text-lg text-gray-800">Zapatitos de beb칠</h3>
                    <ul class="list-disc list-inside mt-2 text-gray-700">
                        <li>Zapatitos b치sicos: **S/ 30 - S/ 50**</li>
                        <li>Zapatitos tipo tenis o botita: **S/ 45 - S/ 70**</li>
                        <li>Zapatitos con detalles (flores, pompones): **S/ 50 - S/ 80**</li>
                    </ul>
                </div>
                <div class="bg-gray-100 p-4 rounded-lg">
                    <h3 class="font-bold text-lg text-gray-800">Amigurumis</h3>
                    <ul class="list-disc list-inside mt-2 text-gray-700">
                        <li>Amigurumi peque침o (10-15 cm): **S/ 40 - S/ 70**</li>
                        <li>Amigurumi mediano (15-25 cm): **S/ 70 - S/ 120**</li>
                        <li>Amigurumi grande (+25 cm) o complejo: **S/ 120 - S/ 250+**</li>
                    </ul>
                </div>
            </div>
        </section>

        <!-- Inventario Global de Materiales -->
        <section class="card mb-8">
            <div class="flex items-center gap-4 mb-4">
                <h2 class="text-2xl font-semibold text-[#754436]">1. Mi Inventario de Materiales Globales</h2>
                <div class="flex-grow"></div>
                <label for="currency-symbol-input" class="text-sm font-medium text-gray-700">S칤mbolo de moneda:</label>
                <input type="text" id="currency-symbol-input" class="input-field w-16 text-center" value="S/">
            </div>
            <p class="text-gray-600 mb-4">Define tus materiales base para reutilizarlos en todos tus c치lculos. Puedes usar gramos (g), metros (m) o unidades (ud).</p>
            <div id="global-materials-rows" class="space-y-3">
                <!-- Filas de materiales globales se insertar치n aqu칤 -->
            </div>
            <div class="mt-4 flex flex-col md:flex-row gap-4">
                <button id="add-global-material-btn" class="btn btn-secondary flex-1">A침adir Material Global +</button>
            </div>
        </section>

        <!-- Contenedor para ambas calculadoras -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- APARTADO 1: CALCULADORA PARA ZAPATITOS -->
            <section class="card">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold text-[#754436]">游빉 Zapatitos a Crochet</h2>
                    <input type="text" id="zapatitos-product-name" class="input-field max-w-[150px]" placeholder="Nombre del producto">
                </div>
                
                <h3 class="text-xl font-medium text-gray-800 mb-2">Paso 1: Materiales utilizados</h3>
                <div id="zapatitos-materials-rows" class="space-y-3 mb-4">
                    <!-- Filas de materiales para zapatitos -->
                </div>
                <button id="add-zapatitos-material-btn" class="btn btn-secondary">A침adir Material al Producto +</button>

                <hr class="my-6">

                <h3 class="text-xl font-medium text-gray-800 mb-2">Paso 2: Mano de Obra y Gastos</h3>
                <div class="space-y-3 mb-6">
                    <div>
                        <label for="zapatitos-work-hours" class="block text-sm font-medium text-gray-700">Horas de trabajo</label>
                        <input type="number" id="zapatitos-work-hours" class="input-field mt-1" placeholder="Ej: 5" min="0" step="0.5">
                    </div>
                    <div>
                        <label for="zapatitos-hourly-rate" class="block text-sm font-medium text-gray-700">Valor por hora (<span class="currency-symbol">S/</span>)</label>
                        <input type="number" id="zapatitos-hourly-rate" class="input-field mt-1" placeholder="Ej: 10" min="0" step="0.50">
                    </div>
                </div>

                <div class="space-y-3 mb-6">
                    <div>
                        <label for="zapatitos-packaging-cost" class="block text-sm font-medium text-gray-700">Empaque y etiquetas (<span class="currency-symbol">S/</span>)</label>
                        <input type="number" id="zapatitos-packaging-cost" class="input-field mt-1" placeholder="Ej: 2.50" min="0" step="0.10">
                    </div>
                </div>

                <div class="price-display">
                    <h3 class="text-lg font-medium">Costo Total de Producci칩n</h3>
                    <div class="text-sm text-left w-full mx-auto px-4 mt-2">
                        <p>Costo Materiales: <span id="zapatitos-materials-cost" class="font-bold float-right"><span class="currency-symbol">S/</span> 0.00</span></p>
                        <p>Costo Mano de Obra: <span id="zapatitos-labor-cost" class="font-bold float-right"><span class="currency-symbol">S/</span> 0.00</span></p>
                        <p>Otros Gastos: <span id="zapatitos-other-costs" class="font-bold float-right"><span class="currency-symbol">S/</span> 0.00</span></p>
                    </div>
                    <div class="chart-container mb-4">
                        <canvas id="zapatitos-cost-chart"></canvas>
                    </div>
                    <p class="text-2xl font-semibold mt-4">Total:</p>
                    <p id="zapatitos-total-cost" class="text-4xl font-bold mt-1"><span class="currency-symbol">S/</span> 0.00</p>
                </div>
                
                <hr class="my-6">

                <h3 class="text-xl font-medium text-gray-800 mb-2">Paso 3: Ganancia y Precio de Venta</h3>
                <div class="space-y-3">
                    <div>
                        <label for="zapatitos-profit-margin" class="block text-sm font-medium text-gray-700">Margen de ganancia: <span id="zapatitos-profit-percentage" class="font-bold">30%</span></label>
                        <input type="range" id="zapatitos-profit-margin" min="0" max="200" value="30" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer mt-1" style="accent-color: #D57A66;">
                    </div>
                    <div>
                        <label for="zapatitos-final-price-input" class="block text-sm font-medium text-gray-700">O ingresa un precio de venta (<span class="currency-symbol">S/</span>)</label>
                        <input type="number" id="zapatitos-final-price-input" class="input-field mt-1" placeholder="Ej: 50" min="0" step="0.10">
                    </div>
                </div>

                <div class="mt-4 price-display">
                    <h3 class="text-lg font-medium">Precio de Venta Sugerido</h3>
                    <p id="zapatitos-final-price" class="text-4xl font-bold mt-1"><span class="currency-symbol">S/</span> 0.00</p>
                    <p id="zapatitos-net-profit" class="text-xl mt-2">Ganancia neta: <span class="currency-symbol">S/</span> 0.00</p>
                    <p id="zapatitos-profit-rate" class="text-xl">Rentabilidad: 0%</p>
                </div>

            </section>

            <!-- APARTADO 2: CALCULADORA PARA AMIGURUMIS -->
            <section class="card">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold text-[#754436]">游빘 Amigurumis</h2>
                    <input type="text" id="amigurumis-product-name" class="input-field max-w-[150px]" placeholder="Nombre del producto">
                </div>

                <h3 class="text-xl font-medium text-gray-800 mb-2">Paso 1: Materiales utilizados</h3>
                <div id="amigurumis-materials-rows" class="space-y-3 mb-4">
                    <!-- Filas de materiales para amigurumis -->
                </div>
                <button id="add-amigurumis-material-btn" class="btn btn-secondary">A침adir Material al Producto +</button>
                
                <hr class="my-6">

                <h3 class="text-xl font-medium text-gray-800 mb-2">Paso 2: Mano de Obra y Gastos</h3>
                <div class="space-y-3 mb-6">
                    <div>
                        <label for="amigurumis-work-hours" class="block text-sm font-medium text-gray-700">Horas de trabajo</label>
                        <input type="number" id="amigurumis-work-hours" class="input-field mt-1" placeholder="Ej: 8" min="0" step="0.5">
                    </div>
                    <div>
                        <label for="amigurumis-hourly-rate" class="block text-sm font-medium text-gray-700">Valor por hora (<span class="currency-symbol">S/</span>)</label>
                        <input type="number" id="amigurumis-hourly-rate" class="input-field mt-1" placeholder="Ej: 10" min="0" step="0.50">
                    </div>
                </div>

                <div class="space-y-3 mb-6">
                    <div>
                        <label for="amigurumis-packaging-cost" class="block text-sm font-medium text-gray-700">Empaque, ojos de seguridad, etc. (<span class="currency-symbol">S/</span>)</label>
                        <input type="number" id="amigurumis-packaging-cost" class="input-field mt-1" placeholder="Ej: 3.00" min="0" step="0.10">
                    </div>
                </div>

                <div class="price-display">
                    <h3 class="text-lg font-medium">Costo Total de Producci칩n</h3>
                    <div class="text-sm text-left w-full mx-auto px-4 mt-2">
                        <p>Costo Materiales: <span id="amigurumis-materials-cost" class="font-bold float-right"><span class="currency-symbol">S/</span> 0.00</span></p>
                        <p>Costo Mano de Obra: <span id="amigurumis-labor-cost" class="font-bold float-right"><span class="currency-symbol">S/</span> 0.00</span></p>
                        <p>Otros Gastos: <span id="amigurumis-other-costs" class="font-bold float-right"><span class="currency-symbol">S/</span> 0.00</span></p>
                    </div>
                    <div class="chart-container mb-4">
                        <canvas id="amigurumis-cost-chart"></canvas>
                    </div>
                    <p class="text-2xl font-semibold mt-4">Total:</p>
                    <p id="amigurumis-total-cost" class="text-4xl font-bold mt-1"><span class="currency-symbol">S/</span> 0.00</p>
                </div>

                <hr class="my-6">
                
                <h3 class="text-xl font-medium text-gray-800 mb-2">Paso 3: Ganancia y Precio de Venta</h3>
                <div class="space-y-3">
                    <div>
                        <label for="amigurumis-profit-margin" class="block text-sm font-medium text-gray-700">Margen de ganancia: <span id="amigurumis-profit-percentage" class="font-bold">30%</span></label>
                        <input type="range" id="amigurumis-profit-margin" min="0" max="200" value="30" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer mt-1" style="accent-color: #D57A66;">
                    </div>
                    <div>
                        <label for="amigurumis-final-price-input" class="block text-sm font-medium text-gray-700">O ingresa un precio de venta (<span class="currency-symbol">S/</span>)</label>
                        <input type="number" id="amigurumis-final-price-input" class="input-field mt-1" placeholder="Ej: 80" min="0" step="0.10">
                    </div>
                </div>

                <div class="mt-4 price-display">
                    <h3 class="text-lg font-medium">Precio de Venta Sugerido</h3>
                    <p id="amigurumis-final-price" class="text-4xl font-bold mt-1"><span class="currency-symbol">S/</span> 0.00</p>
                    <p id="amigurumis-net-profit" class="text-xl mt-2">Ganancia neta: <span class="currency-symbol">S/</span> 0.00</p>
                    <p id="amigurumis-profit-rate" class="text-xl">Rentabilidad: 0%</p>
                </div>
            </section>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Referencias a elementos del DOM
            const globalMaterialsContainer = document.getElementById('global-materials-rows');
            const addGlobalMaterialBtn = document.getElementById('add-global-material-btn');

            const zapatitosMaterialsContainer = document.getElementById('zapatitos-materials-rows');
            const addZapatitosMaterialBtn = document.getElementById('add-zapatitos-material-btn');

            const amigurumisMaterialsContainer = document.getElementById('amigurumis-materials-rows');
            const addAmigurumisMaterialBtn = document.getElementById('add-amigurumis-material-btn');

            const currencySymbolInput = document.getElementById('currency-symbol-input');
            const currencySymbolSpans = document.querySelectorAll('.currency-symbol');

            // Objeto para almacenar el inventario global de materiales
            let globalMaterials = {};
            let globalMaterialIdCounter = 0;

            /**
             * Actualiza el s칤mbolo de la moneda en toda la aplicaci칩n.
             */
            const updateCurrencySymbol = () => {
                const symbol = currencySymbolInput.value || 'S/';
                currencySymbolSpans.forEach(span => {
                    span.textContent = symbol;
                });
            };

            /**
             * Genera una fila para un material en el inventario global.
             * @param {string} name Nombre del material (opcional para pre-rellenar).
             * @param {string} unit Unidad de medida (opcional).
             * @param {number} totalQty Cantidad total del ovillo (opcional).
             * @param {number} totalCost Costo total del ovillo (opcional).
             */
            const createGlobalMaterialRow = (name = '', unit = '', totalQty = '', totalCost = '') => {
                const id = `global-mat-${globalMaterialIdCounter++}`;
                const row = document.createElement('div');
                row.id = id;
                row.classList.add('grid', 'grid-cols-12', 'gap-2', 'items-center');
                row.innerHTML = `
                    <div class="col-span-4">
                        <input type="text" class="input-field global-mat-name" placeholder="Ej: Hilo de algod칩n" value="${name}">
                    </div>
                    <div class="col-span-2">
                        <input type="text" class="input-field global-mat-unit" placeholder="g/m/ud" value="${unit}">
                    </div>
                    <div class="col-span-3">
                        <input type="number" class="input-field global-mat-total-qty" placeholder="Cantidad total" min="0" step="any" value="${totalQty}">
                    </div>
                    <div class="col-span-2">
                        <input type="number" class="input-field global-mat-total-cost" placeholder="Costo total" min="0" step="any" value="${totalCost}">
                    </div>
                    <div class="col-span-1 text-right">
                        <button class="remove-global-material-btn text-red-500 hover:text-red-700 text-xl">&times;</button>
                    </div>
                `;
                globalMaterialsContainer.appendChild(row);
                // Llamar a calculateAll para que el nuevo material se agregue al objeto globalMaterials
                calculateAll();
            };

            /**
             * Genera una fila para un material usado en un producto espec칤fico.
             * @param {HTMLElement} container El contenedor donde se a침adir치 la fila.
             */
            const createProductMaterialRow = (container) => {
                const row = document.createElement('div');
                row.classList.add('grid', 'grid-cols-12', 'gap-2', 'items-center');
                row.innerHTML = `
                    <div class="col-span-6">
                        <select class="input-field product-mat-select">
                            <option value="" disabled selected>Seleccionar material</option>
                        </select>
                    </div>
                    <div class="col-span-3">
                        <input type="number" class="input-field product-mat-quantity" placeholder="Cantidad usada" min="0" step="any">
                    </div>
                    <div class="col-span-2 text-right font-medium">
                        <span class="product-mat-cost"><span class="currency-symbol">S/</span> 0.00</span>
                    </div>
                    <div class="col-span-1 text-right">
                        <button class="remove-product-material-btn text-red-500 hover:text-red-700 text-xl">&times;</button>
                    </div>
                `;
                container.appendChild(row);
                updateProductMaterialSelects();
            };

            /**
             * Actualiza los men칰s desplegables de materiales en ambas calculadoras
             * con los materiales del inventario global.
             */
            const updateProductMaterialSelects = () => {
                const productSelects = document.querySelectorAll('.product-mat-select');
                productSelects.forEach(select => {
                    const selectedValue = select.value;
                    select.innerHTML = '<option value="" disabled selected>Seleccionar material</option>';
                    for (const id in globalMaterials) {
                        const material = globalMaterials[id];
                        const option = document.createElement('option');
                        option.value = id;
                        option.textContent = `${material.name} (${material.unit})`;
                        select.appendChild(option);
                    }
                    select.value = selectedValue;
                });
            };

            /**
             * Formatea un n칰mero a un formato de moneda.
             * @param {number} value El valor a formatear.
             * @returns {string} El valor formateado.
             */
            const formatCurrency = (value) => {
                const symbol = currencySymbolInput.value || 'S/';
                return `${symbol} ${Number(value).toFixed(2)}`;
            };

            /**
             * Configuraci칩n del gr치fico (Doughnut Chart)
             * @param {string} canvasId ID del elemento canvas.
             * @param {Array<number>} initialData Datos iniciales del gr치fico.
             * @returns {Chart} Instancia del gr치fico.
             */
            const setupChart = (canvasId, initialData) => {
                const ctx = document.getElementById(canvasId).getContext('2d');
                return new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Materiales', 'Mano de Obra', 'Otros Gastos'],
                        datasets: [{
                            data: initialData,
                            backgroundColor: ['#D57A66', '#E8CFC8', '#796E63'],
                            borderColor: '#FDFBF8',
                            borderWidth: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '60%',
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 20,
                                    font: { family: "'Inter', sans-serif" }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: (context) => {
                                        let label = context.label || '';
                                        if (label) label += ': ';
                                        if (context.parsed !== null) label += formatCurrency(context.parsed);
                                        return label;
                                    }
                                }
                            }
                        }
                    }
                });
            };

            const zapatitosChart = setupChart('zapatitos-cost-chart', [0, 0, 0]);
            const amigurumisChart = setupChart('amigurumis-cost-chart', [0, 0, 0]);

            // Funci칩n para actualizar todos los c치lculos
            const calculateAll = (e) => {
                // Actualizar inventario global de materiales
                const globalRows = globalMaterialsContainer.querySelectorAll('.grid');
                globalMaterials = {}; // Reinicia el objeto de materiales globales
                globalRows.forEach(row => {
                    const id = row.id;
                    const name = row.querySelector('.global-mat-name').value;
                    const unit = row.querySelector('.global-mat-unit').value || 'ud';
                    const totalQty = parseFloat(row.querySelector('.global-mat-total-qty').value) || 0;
                    const totalCost = parseFloat(row.querySelector('.global-mat-total-cost').value) || 0;
                    const costPerUnit = totalQty > 0 ? totalCost / totalQty : 0;
                    globalMaterials[id] = { name, unit, totalQty, totalCost, costPerUnit };
                });
                
                // Actualizar los selectores de materiales
                updateProductMaterialSelects();

                // Calcular y actualizar la secci칩n de zapatitos
                calculateAndDisplay('zapatitos-', e);

                // Calcular y actualizar la secci칩n de amigurumis
                calculateAndDisplay('amigurumis-', e);
            };

            /**
             * Realiza los c치lculos y actualiza la UI para una secci칩n espec칤fica.
             * @param {string} prefix El prefijo de los IDs de los elementos (e.g., 'zapatitos-').
             * @param {Event} e El evento que dispar칩 la funci칩n.
             */
            const calculateAndDisplay = (prefix, e) => {
                // 1. Calcular Costos de Materiales
                let materialsSubtotal = 0;
                const productMaterialsContainer = document.getElementById(`${prefix}materials-rows`);
                const productMaterialRows = productMaterialsContainer.querySelectorAll('.grid');
                productMaterialRows.forEach(row => {
                    const select = row.querySelector('.product-mat-select');
                    const quantity = parseFloat(row.querySelector('.product-mat-quantity').value) || 0;
                    const materialId = select.value;
                    let total = 0;
                    if (globalMaterials[materialId]) {
                        total = quantity * globalMaterials[materialId].costPerUnit;
                    }
                    const costDisplay = row.querySelector('.product-mat-cost');
                    if (costDisplay) {
                        costDisplay.innerHTML = formatCurrency(total);
                    }
                    materialsSubtotal += total;
                });
                
                // 2. Calcular Costos de Mano de Obra y Otros Gastos
                const workHours = parseFloat(document.getElementById(`${prefix}work-hours`).value) || 0;
                const hourlyRate = parseFloat(document.getElementById(`${prefix}hourly-rate`).value) || 0;
                const otherCosts = parseFloat(document.getElementById(`${prefix}packaging-cost`).value) || 0;

                const laborSubtotal = workHours * hourlyRate;
                const otherCostsSubtotal = otherCosts;
                
                // 3. Calcular Costo Total
                const totalCost = materialsSubtotal + laborSubtotal + otherCostsSubtotal;

                // 4. Actualizar la UI del Resumen
                const profitMarginSlider = document.getElementById(`${prefix}profit-margin`);
                const finalPriceInput = document.getElementById(`${prefix}final-price-input`);

                let finalPrice = parseFloat(finalPriceInput.value) || 0;
                let profitPercentage = parseFloat(profitMarginSlider.value) || 0;

                const targetId = e?.target?.id;

                // L칩gica para sincronizar el slider y el input de precio final
                if (targetId && targetId === `${prefix}profit-margin`) {
                    if (totalCost > 0) {
                        finalPrice = totalCost + (totalCost * (profitPercentage / 100));
                        finalPriceInput.value = finalPrice.toFixed(2);
                    } else {
                        finalPrice = 0;
                        finalPriceInput.value = "";
                    }
                } else if (targetId && targetId === `${prefix}final-price-input`) {
                    if (totalCost > 0) {
                        profitPercentage = ((finalPrice - totalCost) / totalCost) * 100;
                        profitMarginSlider.value = Math.max(0, Math.min(200, profitPercentage));
                    } else {
                        profitPercentage = 0;
                        profitMarginSlider.value = 0;
                    }
                } else {
                    if (totalCost > 0) {
                        finalPrice = totalCost + (totalCost * (profitPercentage / 100));
                    } else {
                         finalPrice = 0;
                    }
                }

                // 5. Actualizar la UI de los resultados
                document.getElementById(`${prefix}materials-cost`).innerHTML = formatCurrency(materialsSubtotal);
                document.getElementById(`${prefix}labor-cost`).innerHTML = formatCurrency(laborSubtotal);
                document.getElementById(`${prefix}other-costs`).innerHTML = formatCurrency(otherCostsSubtotal);

                document.getElementById(`${prefix}total-cost`).innerHTML = formatCurrency(totalCost);
                document.getElementById(`${prefix}final-price`).innerHTML = formatCurrency(finalPrice);
                document.getElementById(`${prefix}profit-percentage`).textContent = `${profitPercentage.toFixed(0)}%`;
                
                const netProfit = finalPrice - totalCost;
                const profitRate = totalCost > 0 ? (netProfit / totalCost) * 100 : 0;
                
                document.getElementById(`${prefix}net-profit`).innerHTML = `Ganancia neta: ${formatCurrency(netProfit)}`;
                document.getElementById(`${prefix}profit-rate`).textContent = `Rentabilidad: ${profitRate.toFixed(2)}%`;
                
                // 6. Actualizar el gr치fico
                const chart = (prefix === 'zapatitos-') ? zapatitosChart : amigurumisChart;
                chart.data.datasets[0].data = [materialsSubtotal, laborSubtotal, otherCostsSubtotal];
                chart.update();
            }
            
            // Event Listeners
            addGlobalMaterialBtn.addEventListener('click', () => createGlobalMaterialRow());
            addZapatitosMaterialBtn.addEventListener('click', () => createProductMaterialRow(zapatitosMaterialsContainer));
            addAmigurumisMaterialBtn.addEventListener('click', () => createProductMaterialRow(amigurumisMaterialsContainer));
            
            currencySymbolInput.addEventListener('input', updateCurrencySymbol);

            document.body.addEventListener('input', calculateAll);
            document.body.addEventListener('change', calculateAll);

            document.body.addEventListener('click', (e) => {
                if (e.target.classList.contains('remove-global-material-btn')) {
                    const row = e.target.closest('.grid');
                    if (row) {
                        delete globalMaterials[row.id];
                        row.remove();
                        calculateAll();
                    }
                }
                if (e.target.classList.contains('remove-product-material-btn')) {
                    const row = e.target.closest('.grid');
                    if (row) {
                        row.remove();
                        calculateAll();
                    }
                }
            });

            // Llenar con datos de ejemplo al cargar la p치gina
            const initialSetup = () => {
                // Pre-rellenar inventario global
                createGlobalMaterialRow('Hilo de algod칩n', 'g', 100, 15.00);
                createGlobalMaterialRow('Relleno sint칠tico', 'g', 500, 20.00);
                createGlobalMaterialRow('Ojos de seguridad', 'ud', 10, 3.00);
                
                // Pre-rellenar calculadora de Zapatitos
                document.getElementById('zapatitos-product-name').value = 'Zapatitos de Gato';
                createProductMaterialRow(zapatitosMaterialsContainer);
                const zapatitosSelect = zapatitosMaterialsContainer.querySelector('.product-mat-select');
                zapatitosSelect.addEventListener('change', calculateAll);
                // Esperar a que los materiales globales se carguen para seleccionar la opci칩n
                setTimeout(() => {
                    const zapatitosFirstSelect = zapatitosMaterialsContainer.querySelector('.product-mat-select');
                    if (zapatitosFirstSelect && globalMaterials['global-mat-0']) {
                        zapatitosFirstSelect.value = 'global-mat-0';
                        zapatitosMaterialsContainer.querySelector('.product-mat-quantity').value = 50;
                    }
                    document.getElementById('zapatitos-work-hours').value = 3;
                    document.getElementById('zapatitos-hourly-rate').value = 10;
                    document.getElementById('zapatitos-packaging-cost').value = 2.50;
                    document.getElementById('zapatitos-profit-margin').value = 30;
                    calculateAll();
                }, 50);

                // Pre-rellenar calculadora de Amigurumis
                document.getElementById('amigurumis-product-name').value = 'Oso de Peluche';
                createProductMaterialRow(amigurumisMaterialsContainer);
                const amigurumisFirstSelect = amigurumisMaterialsContainer.querySelector('.product-mat-select');
                 setTimeout(() => {
                    if (amigurumisFirstSelect && globalMaterials['global-mat-0'] && globalMaterials['global-mat-1']) {
                        amigurumisFirstSelect.value = 'global-mat-0';
                        amigurumisMaterialsContainer.querySelector('.product-mat-quantity').value = 80;
                    }
                    createProductMaterialRow(amigurumisMaterialsContainer);
                    const amigurumisSecondSelect = amigurumisMaterialsContainer.querySelectorAll('.product-mat-select')[1];
                    if (amigurumisSecondSelect && globalMaterials['global-mat-1']) {
                        amigurumisSecondSelect.value = 'global-mat-1';
                        amigurumisMaterialsContainer.querySelectorAll('.product-mat-quantity')[1].value = 20;
                    }

                    document.getElementById('amigurumis-work-hours').value = 8;
                    document.getElementById('amigurumis-hourly-rate').value = 12;
                    document.getElementById('amigurumis-packaging-cost').value = 5.00;
                    document.getElementById('amigurumis-profit-margin').value = 40;
                    calculateAll();
                 }, 100);
                 
                updateCurrencySymbol(); 
                calculateAll();
            };

            initialSetup();
        });
    </script>
</body>
</html>
